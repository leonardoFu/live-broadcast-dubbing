# Implementation Plan: Audio Transcription Module (ASR Component)

**Branch**: `feature2` | **Date**: 2025-12-28 | **Spec**: `specs/005-audio-transcription-module.md`
**Input**: Feature specification from `specs/005-audio-transcription-module.md`

---

## Summary

Implement a reusable ASR component that transcribes short audio fragments (~1-2 seconds) from live streams into timestamped transcripts. The component uses **faster-whisper** for CPU-friendly Whisper inference, supports domain priming for sports commentary, and produces structured output compatible with the STS pipeline defined in `specs/004-sts-pipeline-design.md`.

Key deliverables:
- `FasterWhisperASR`: Production implementation with model caching, VAD, and utterance shaping
- `MockASRComponent`: Deterministic stub for testing
- Pydantic data models for typed input/output contracts
- Test suite using real audio fixtures (`1-min-nfl.m4a`, `big-buck-bunny.mp4`)

---

## Technical Context

**Language/Version**: Python 3.10.x (per constitution)
**Primary Dependencies**:
- `faster-whisper` (Whisper via CTranslate2, CPU-friendly)
- `numpy<2.0`, `scipy` (audio preprocessing)
- `soundfile` (audio I/O)
- `pydantic` (typed contracts)

**Storage**: In-memory audio payloads with reference strings; optional debug artifact persistence
**Testing**: pytest, pytest-mock, pytest-cov
**Target Platform**: Linux server (EC2/RunPod), macOS (local dev)
**Project Type**: Module within `apps/sts-service/`
**Performance Goals**: <500ms per 2-second fragment on CPU (base model)
**Constraints**: No GPU required (CPU-first); GPU optional for acceleration
**Scale/Scope**: Single-stream processing; model caching across fragments

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Principle I - Real-Time First**: [PASS]
- [x] Fragment-based processing (~1-2s chunks)
- [x] No batch-completion blocking
- [x] Target latency: <500ms per fragment

**Principle II - Testability Through Isolation**: [PASS]
- [x] MockASRComponent provides deterministic behavior
- [x] No live RTMP endpoints required for unit tests
- [x] Real audio fixtures for integration tests

**Principle III - Spec-Driven Development**: [PASS]
- [x] Implementation follows `specs/005-audio-transcription-module.md`
- [x] Contracts aligned with `specs/004-sts-pipeline-design.md`

**Principle IV - Observability & Debuggability**: [PASS]
- [x] ASRMetrics model defined for structured logging
- [x] Processing time breakdown (preprocess, transcribe, postprocess)
- [x] Debug artifact persistence behind flag

**Principle V - Graceful Degradation**: [PASS]
- [x] Error classification with retryable flag
- [x] SUCCESS with empty segments for silence (no hallucination)
- [x] Timeout handling with configurable deadline

**Principle VIII - Test-First Development (NON-NEGOTIABLE)**: [PASS]
- [x] Test strategy defined for all components
- [x] Mock patterns documented (MockASRComponent)
- [x] Coverage targets: 80% minimum, 95% for critical paths
- [x] Test organization: `apps/sts-service/tests/{unit,integration}/asr/`

---

## Project Structure

### Documentation (this feature)

```text
specs/005-audio-transcription-module/
├── plan.md              # This file
├── research.md          # faster-whisper best practices, decisions
├── data-model.md        # Pydantic models (AudioFragment, TranscriptAsset)
├── quickstart.md        # Setup and usage guide
├── contracts/
│   ├── asr-component.json   # JSON Schema for input/output
│   └── asr-interface.py     # ASRComponent protocol definition
└── tasks.md             # Generated by /speckit.tasks (next step)
```

### Source Code (repository root)

```text
apps/sts-service/
├── pyproject.toml
├── requirements.txt
├── requirements-dev.txt
├── src/
│   └── sts_service/
│       ├── __init__.py
│       └── asr/
│           ├── __init__.py           # Public API: FasterWhisperASR, MockASRComponent
│           ├── models.py             # Pydantic: AudioFragment, TranscriptAsset, etc.
│           ├── interface.py          # ASRComponent protocol
│           ├── preprocessing.py      # preprocess_audio(), highpass, preemphasis
│           ├── transcriber.py        # FasterWhisperASR implementation
│           ├── mock.py               # MockASRComponent for testing
│           ├── postprocessing.py     # improve_sentence_boundaries(), split_long_segments()
│           ├── domain_prompts.py     # get_domain_prompt()
│           ├── confidence.py         # Confidence score mapping
│           └── errors.py             # ASRError, ASRErrorType, classification
└── tests/
    ├── unit/
    │   └── asr/
    │       ├── __init__.py
    │       ├── test_models.py        # Pydantic model validation
    │       ├── test_preprocessing.py # Audio preprocessing functions
    │       ├── test_postprocessing.py # Utterance shaping
    │       ├── test_domain_prompts.py
    │       ├── test_confidence.py
    │       ├── test_errors.py
    │       └── test_mock.py          # MockASRComponent behavior
    └── integration/
        └── asr/
            ├── __init__.py
            ├── test_transcriber.py   # FasterWhisperASR with mocked model
            ├── test_fixtures.py      # Real transcription with audio fixtures
            └── conftest.py           # Shared fixtures
```

**Structure Decision**: Single module within `apps/sts-service/` following the monorepo structure from `specs/001-python-monorepo-setup/`. ASR is a subpackage under `sts_service` that can be imported independently.

---

## Test Strategy

### Test Levels for This Feature

**Unit Tests** (mandatory):
- Target: All preprocessing, postprocessing, confidence mapping, error classification
- Tools: pytest, pytest-mock
- Coverage: 80% minimum
- Mocking: Mock `WhisperModel` for transcriber tests
- Location: `apps/sts-service/tests/unit/asr/`

**Contract Tests** (mandatory):
- Target: Pydantic model validation, JSON schema conformance
- Tools: pytest with Pydantic validation
- Coverage: 100% of all model fields and constraints
- Location: `apps/sts-service/tests/unit/asr/test_models.py`

**Integration Tests** (required for workflows):
- Target: FasterWhisperASR with real faster-whisper model and audio fixtures
- Tools: pytest with real audio files
- Coverage: Happy path + silence detection + error handling
- Fixtures:
  - `tests/fixtures/test-streams/1-min-nfl.m4a` - Sports transcription
  - `tests/fixtures/test-streams/1-min-nfl.mp4` - Audio extraction + transcription
  - `tests/fixtures/test-streams/big-buck-bunny.mp4` - Silence/no-speech detection
- Location: `apps/sts-service/tests/integration/asr/`

### Mock Patterns (Constitution Principle II)

**MockASRComponent**:
```python
# Deterministic behavior for unit tests
mock_asr = MockASRComponent(MockASRConfig(
    default_text="Touchdown Chiefs!",
    default_confidence=0.92,
))
result = mock_asr.transcribe(audio_data=b"ignored", ...)
assert result.segments[0].text == "Touchdown Chiefs!"
```

**Mocked WhisperModel**:
```python
# For transcriber unit tests
@pytest.fixture
def mock_whisper_model(mocker):
    mock = mocker.Mock()
    mock.transcribe.return_value = (
        [mock_segment(text="Hello world", start=0.0, end=1.0)],
        mock_info(language="en"),
    )
    return mock
```

### Coverage Enforcement

**Pre-commit**: Run `pytest --cov --cov-fail-under=80`
**CI**: Block merge if coverage < 80%
**Critical paths**: ASR transcription, preprocessing, postprocessing -> 95% minimum

### Test Naming Conventions

- `test_preprocess_audio_normalizes_amplitude()`
- `test_preprocess_audio_applies_highpass_filter()`
- `test_transcribe_returns_success_for_speech()`
- `test_transcribe_returns_empty_segments_for_silence()`
- `test_transcribe_error_timeout()`
- `test_improve_sentence_boundaries_merges_short_segments()`
- `test_split_long_segments_at_sentence_boundary()`

---

## Implementation Phases

### Phase 0: Foundation (Models + Interface)

**Goal**: Establish typed contracts and abstract interface

1. **Pydantic Models** (`src/sts_service/asr/models.py`):
   - `AudioFragment` - Input model
   - `WordTiming` - Word-level timestamps
   - `TranscriptSegment` - Output segment
   - `ASRError`, `ASRErrorType` - Error handling
   - `TranscriptAsset`, `TranscriptStatus` - Complete output
   - `ASRConfig`, `ASRModelConfig`, `VADConfig`, etc.

2. **Interface** (`src/sts_service/asr/interface.py`):
   - `ASRComponent` protocol
   - `BaseASRComponent` abstract class

3. **Tests**:
   - `test_models.py` - Validation rules, edge cases
   - Model instantiation, serialization, computed properties

### Phase 1: Preprocessing + Postprocessing

**Goal**: Audio quality and utterance shaping without ASR dependency

1. **Preprocessing** (`src/sts_service/asr/preprocessing.py`):
   - `preprocess_audio(audio_data, sample_rate)` -> processed array
   - High-pass filter (80Hz, scipy)
   - Pre-emphasis (0.97 coefficient)
   - Normalization
   - Resample to 16kHz if needed

2. **Postprocessing** (`src/sts_service/asr/postprocessing.py`):
   - `improve_sentence_boundaries(segments)` -> merged segments
   - `split_long_segments(segments, max_duration)` -> split segments
   - `enhance_with_ner(text, domain)` -> enhanced text

3. **Domain Prompts** (`src/sts_service/asr/domain_prompts.py`):
   - `get_domain_prompt(domain)` -> prompt string
   - Sports, football, basketball, news, interview, general

4. **Confidence** (`src/sts_service/asr/confidence.py`):
   - `calculate_confidence(avg_logprob)` -> float 0-1
   - Linear mapping from avg_logprob

5. **Tests** (TDD - write first):
   - `test_preprocessing.py` - All filter functions
   - `test_postprocessing.py` - Merge/split behavior
   - `test_domain_prompts.py` - All domains
   - `test_confidence.py` - Edge cases

### Phase 2: Mock Implementation

**Goal**: Deterministic testing capability

1. **MockASRComponent** (`src/sts_service/asr/mock.py`):
   - Ignores audio content
   - Returns configured text with deterministic timestamps
   - Supports failure injection
   - Configurable via `MockASRConfig`

2. **Tests**:
   - `test_mock.py` - All mock behaviors
   - Deterministic output verification
   - Error injection testing

### Phase 3: Real Implementation

**Goal**: Production-ready faster-whisper integration

1. **FasterWhisperASR** (`src/sts_service/asr/transcriber.py`):
   - Model loading with global cache
   - Audio preprocessing integration
   - faster-whisper transcription
   - VAD configuration
   - Segment extraction and postprocessing
   - Error handling and classification
   - Timeout enforcement

2. **Error Classification** (`src/sts_service/asr/errors.py`):
   - Map exceptions to `ASRErrorType`
   - Retryable classification

3. **Tests**:
   - `test_transcriber.py` (unit) - Mocked WhisperModel
   - `test_transcriber.py` (integration) - Real model, synthetic audio

### Phase 4: Integration with Fixtures

**Goal**: Validate with real audio content

1. **Fixture Tests** (`tests/integration/asr/test_fixtures.py`):
   - `test_nfl_audio_transcription()` - Sports domain
   - `test_nfl_domain_priming()` - Vocabulary bias
   - `test_silence_detection()` - big-buck-bunny
   - `test_timestamp_alignment()` - Known content timing

2. **Benchmark Tests** (optional):
   - Processing time per fragment
   - Memory usage

### Phase 5: Public API + Documentation

**Goal**: Clean module interface

1. **Public API** (`src/sts_service/asr/__init__.py`):
   ```python
   from .transcriber import FasterWhisperASR
   from .mock import MockASRComponent, MockASRConfig
   from .models import (
       AudioFragment, TranscriptAsset, TranscriptSegment,
       TranscriptStatus, ASRError, ASRErrorType,
       ASRConfig, ASRModelConfig, VADConfig,
   )
   from .interface import ASRComponent
   ```

2. **Documentation**:
   - Update `quickstart.md` with final API
   - Docstrings for all public functions

---

## Key Design Decisions

### 1. No librosa Dependency

**Decision**: Use scipy + numpy only for preprocessing
**Rationale**: Reduces dependency footprint, faster installs, smaller containers
**Trade-off**: Slightly more code for equivalent operations

### 2. Global Model Cache

**Decision**: Cache models in module-level dict keyed by (size, device)
**Rationale**: Model loading is expensive (1-5s); fragments share models
**Trade-off**: Memory usage for cached models; acceptable for single-stream workers

### 3. Linear Confidence Mapping

**Decision**: `confidence = clamp((avg_logprob + 1.0) / 1.0, 0, 1)`
**Rationale**: Simple, matches archive behavior, provides relative ranking
**Trade-off**: Not a calibrated probability

### 4. Utterance Shaping in ASR Component

**Decision**: Merge/split segments before returning
**Rationale**: Downstream components (translation, TTS) benefit from well-shaped utterances
**Trade-off**: ASR component has postprocessing responsibility

### 5. Domain Priming via Initial Prompt

**Decision**: Use faster-whisper `initial_prompt` parameter
**Rationale**: No additional model/training; leverages Whisper's context capability
**Trade-off**: Limited vocabulary bias compared to fine-tuning

---

## Complexity Tracking

No constitution violations requiring justification.

---

## Dependencies and Blockers

| Dependency | Status | Notes |
|------------|--------|-------|
| faster-whisper | Available | pip installable |
| scipy | Available | pip installable |
| numpy<2.0 | Available | Pin per constitution |
| soundfile | Available | pip installable |
| pydantic | Available | pip installable |
| Test fixtures | **Available** | `tests/fixtures/test-streams/` |

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| faster-whisper model download fails | Pre-download in Docker build; fallback to smaller model |
| Memory exhaustion | Use `tiny` or `base` models; int8 quantization |
| Slow transcription | Tune beam_size, disable word_timestamps if not needed |
| Hallucination on silence | VAD filter enabled; no_speech_threshold=0.6 |
| Flaky integration tests | Use deterministic audio fixtures; avoid timing-dependent assertions |

---

## Success Criteria

Per `specs/005-audio-transcription-module.md` Section 11:

1. [x] ASR component can transcribe live fragments with aligned timestamps (99%+ success)
2. [x] Silent/no-speech fragments produce no hallucinated text (99%+ accuracy)
3. [x] Module replaceable by deterministic stub (MockASRComponent)
4. [x] 80%+ test coverage; 95%+ for critical paths
5. [x] <500ms latency per 2-second fragment on CPU

---

## Next Steps

1. **Run `/speckit.tasks`** - Generate `tasks.md` with implementation tasks
2. **Run `/speckit.checklist`** - Generate checklist for TDD workflow
3. **Begin Phase 0** - Create Pydantic models and interface (TDD)
