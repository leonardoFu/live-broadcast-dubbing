# Implementation Plan: VAD Audio Segmentation

**Branch**: `023-vad-audio-segmentation` | **Date**: 2026-01-09 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/023-vad-audio-segmentation/spec.md`

## Summary

Replace fixed 6-second audio segmentation with dynamic VAD-based segmentation using GStreamer's native `level` element. The system will detect natural speech boundaries by monitoring RMS levels and emit segments at silence boundaries (1 second of RMS < -50dB), improving translation quality by sending complete utterances to STS.

**Key Technical Approach**:
- Insert GStreamer `level` element into audio pipeline path
- State machine (`VADAudioSegmenter`) tracks silence duration and manages segment emission
- Enforce min (1s) / max (15s) duration constraints
- Fail-fast on missing level element (no fallback to fixed segments)

## Technical Context

**Language/Version**: Python 3.10.x (per constitution and pyproject.toml requirement `>=3.10,<3.11`)
**Primary Dependencies**: GStreamer 1.0 (PyGObject >= 3.44.0), gst-plugins-good (level element), pydantic >= 2.0, prometheus_client
**Storage**: N/A (in-memory accumulator, existing segment files)
**Testing**: pytest, pytest-mock, pytest-asyncio
**Target Platform**: Linux (Docker container), macOS (dev)
**Project Type**: Python monorepo (apps/media-service)
**Performance Goals**: <10ms per level message processing, <100MB memory per stream
**Constraints**: 1-15 second segment duration, 10MB accumulator memory limit, 5s level message timeout
**Scale/Scope**: Single worker per stream, global VAD config (not per-stream for MVP)

## Constitution Check

*GATE: Passed for Phase 0 research. Re-checked for Phase 1 design.*

**Principle VIII - Test-First Development (NON-NEGOTIABLE)**:
- [x] Test strategy defined for all user stories (see quickstart.md)
- [x] Mock patterns documented for level messages and VAD state transitions
- [x] Coverage targets specified (80% minimum, 95% for VADAudioSegmenter critical path)
- [x] Test infrastructure matches constitution requirements (pytest with media-service test structure)
- [x] Test organization follows standard structure (apps/media-service/tests/{unit,integration})

**Principle I - Real-Time First**:
- [x] Level element operates in-stream, no additional buffering beyond accumulator
- [x] Bus message handling is non-blocking (<10ms per message)
- [x] No batch operations - continuous buffer flow

**Principle II - Testability Through Isolation**:
- [x] VADAudioSegmenter testable without GStreamer via callback injection
- [x] Mock fixtures for level messages defined in quickstart.md
- [x] LevelMessageExtractor separately testable

**Principle III - Spec-Driven Development**:
- [x] Spec created and clarified before implementation
- [x] Data model documented in data-model.md
- [x] Contracts defined in contracts/ directory

**Principle V - Graceful Degradation**:
- [x] Fail-fast design explicitly chosen (spec clarification)
- [x] Memory limit prevents unbounded growth
- [x] Max duration enforces upper bound

## Project Structure

### Documentation (this feature)

```text
specs/023-vad-audio-segmentation/
├── plan.md              # This file
├── research.md          # Research decisions and rationale
├── research-cache.md    # Detailed GStreamer level element documentation
├── data-model.md        # Entity definitions (SegmentationConfig, VADAudioSegmenter)
├── quickstart.md        # Test scenarios and manual testing checklist
├── contracts/           # JSON schemas
│   ├── segmentation-config-schema.json
│   └── vad-metrics-schema.json
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
apps/media-service/
├── src/media_service/
│   ├── config/
│   │   └── segmentation_config.py    # NEW: SegmentationConfig Pydantic model
│   ├── vad/                          # NEW: VAD module
│   │   ├── __init__.py
│   │   ├── vad_audio_segmenter.py    # NEW: VADAudioSegmenter state machine
│   │   └── level_message_extractor.py # NEW: RMS extraction utility
│   ├── pipeline/
│   │   └── input.py                  # MODIFY: Add level element to audio path
│   ├── buffer/
│   │   └── segment_buffer.py         # MODIFY: Integrate VAD segmenter
│   ├── worker/
│   │   └── worker_runner.py          # MODIFY: Wire VAD callbacks
│   └── metrics/
│       └── prometheus.py             # MODIFY: Add VAD metrics
│
└── tests/
    ├── unit/
    │   ├── config/
    │   │   └── test_segmentation_config.py  # NEW
    │   ├── vad/
    │   │   ├── test_vad_audio_segmenter.py  # NEW
    │   │   └── test_level_message_extractor.py # NEW
    │   ├── pipeline/
    │   │   └── test_input_level_element.py  # NEW
    │   └── buffer/
    │       └── test_segment_buffer_vad.py   # NEW
    └── integration/
        └── test_vad_integration.py          # NEW
```

**Structure Decision**: Follows existing monorepo structure per `specs/001-python-monorepo-setup/contracts/directory-structure.json`. New VAD module created under `apps/media-service/src/media_service/vad/` to isolate VAD logic.

## Test Strategy

### Test Levels for This Feature

**Unit Tests** (mandatory):
- Target: SegmentationConfig, VADAudioSegmenter, LevelMessageExtractor
- Tools: pytest, pytest-mock
- Coverage: 80% minimum (95% for VADAudioSegmenter)
- Mocking: GStreamer structures, level messages
- Location: `apps/media-service/tests/unit/config/`, `apps/media-service/tests/unit/vad/`

**Contract Tests** (mandatory):
- Target: SegmentationConfig JSON schema, VAD metrics schema
- Tools: pytest with jsonschema validation
- Coverage: 100% of all contracts
- Location: `apps/media-service/tests/contract/`

**Integration Tests** (required for workflows):
- Target: InputPipeline + level element, end-to-end VAD detection
- Tools: pytest with real GStreamer (requires gst-plugins-good)
- Coverage: Happy path + fail-fast scenario
- Location: `apps/media-service/tests/integration/`

**E2E Tests** (out of scope per spec):
- Not included in this feature (manual testing for now)

### Mock Patterns (Constitution Principle II)

**Level Message Mocks**:
```python
def create_mock_level_message(rms: list[float], timestamp_ns: int = 0) -> MockMessage:
    """Create mock GStreamer level message for testing."""
    return MockMessage(
        type=Gst.MessageType.ELEMENT,
        structure=MockStructure(
            name="level",
            fields={"rms": rms, "running-time": timestamp_ns}
        )
    )
```

**VADAudioSegmenter Mocks**:
```python
def create_test_segmenter(on_segment: Callable = None) -> VADAudioSegmenter:
    """Create VADAudioSegmenter with test defaults."""
    return VADAudioSegmenter(
        config=SegmentationConfig(),
        on_segment_ready=on_segment or (lambda *args: None)
    )
```

### Coverage Enforcement

**Pre-commit**: Run `make media-test-coverage` - fail if coverage < 80%
**CI**: Run `pytest --cov --cov-fail-under=80` - block merge if fails
**Critical paths**: VADAudioSegmenter state transitions, silence detection → 95% minimum

### Test Naming Conventions

- `test_vad_silence_boundary_emits_segment()` - Happy path
- `test_vad_max_duration_forces_emission()` - Constraint enforcement
- `test_vad_invalid_rms_raises_error()` - Error handling
- `test_vad_level_element_raises_on_failure()` - Fail-fast
- `test_segmentation_config_from_env()` - Configuration

## Implementation Overview

### Phase 1: Configuration (Priority: P2)

| File | Change | Description |
|------|--------|-------------|
| `config/segmentation_config.py` | NEW | Pydantic BaseSettings model with VAD parameters |

**Key Details**:
- Use `pydantic_settings.BaseSettings` with `env_prefix="VAD_"`
- All parameters have sensible defaults
- Validation via Pydantic Field constraints
- Nanosecond conversion properties

### Phase 2: VAD Core (Priority: P1)

| File | Change | Description |
|------|--------|-------------|
| `vad/__init__.py` | NEW | Module exports |
| `vad/vad_audio_segmenter.py` | NEW | State machine for silence detection |
| `vad/level_message_extractor.py` | NEW | GStreamer message parsing utility |

**Key Details**:
- `VADAudioSegmenter` manages ACCUMULATING/IN_SILENCE states
- Callback-based segment emission (thread-safe)
- Memory limit and duration constraint enforcement
- Invalid RMS validation with fatal error after 10 consecutive

### Phase 3: Pipeline Integration (Priority: P1)

| File | Change | Description |
|------|--------|-------------|
| `pipeline/input.py` | MODIFY | Insert level element after aacparse |

**Key Details**:
- Create level element with `Gst.ElementFactory.make("level", "audio_level")`
- Configure: `interval=100_000_000`, `post-messages=True`
- Fail-fast: Raise `RuntimeError` if level element is None
- Link: `aacparse → level → audio_queue`
- Connect to bus `message::element` signal for level messages

**Pipeline Modification**:
```
BEFORE: aacparse → audio_queue → appsink
AFTER:  aacparse → level → audio_queue → appsink
```

### Phase 4: Buffer Integration (Priority: P1)

| File | Change | Description |
|------|--------|-------------|
| `buffer/segment_buffer.py` | MODIFY | Replace fixed duration with VAD-based emission |

**Key Details**:
- Accept optional `VADAudioSegmenter` in constructor
- When VAD enabled: delegate `push_audio` to segmenter
- When VAD disabled: use existing fixed 6s logic (backward compatible)
- Video path unchanged (pass-through)

### Phase 5: Worker Wiring (Priority: P1)

| File | Change | Description |
|------|--------|-------------|
| `worker/worker_runner.py` | MODIFY | Wire VAD callbacks |

**Key Details**:
- Create `SegmentationConfig` on init
- Create `VADAudioSegmenter` with callback to emit segments
- Pass segmenter to `SegmentBuffer`
- Add `on_level_message` callback to InputPipeline
- Wire level messages to segmenter's `on_level_message`

### Phase 6: Metrics (Priority: P3)

| File | Change | Description |
|------|--------|-------------|
| `metrics/prometheus.py` | MODIFY | Add VAD-specific metrics |

**New Metrics**:
| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `vad_segments_total` | Counter | stream_id, trigger | Segment emissions by trigger |
| `vad_segment_duration_seconds` | Histogram | stream_id | Segment duration distribution |
| `vad_silence_detections_total` | Counter | stream_id | Silence boundary detections |
| `vad_forced_emissions_total` | Counter | stream_id | Max duration forced emissions |
| `vad_min_duration_violations_total` | Counter | stream_id | Min duration violations |
| `vad_memory_limit_emissions_total` | Counter | stream_id | Memory limit emissions |

## Complexity Tracking

No constitution violations requiring justification.

## Dependencies

### Required Packages (Already Present)

- `pydantic >= 2.0` (for BaseSettings)
- `pydantic-settings >= 2.0` (for environment variable loading)
- `prometheus_client` (for metrics)
- `PyGObject >= 3.44.0` (for GStreamer bindings)

### System Dependencies

- `gst-plugins-good` (provides level element)
  - Already installed in Docker image (verify in Dockerfile)
  - Fail-fast check validates availability at startup

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Level element unavailable | Fail-fast at startup with clear error message |
| Memory growth during long silence | 10MB memory limit, 15s max duration |
| Invalid RMS values | Validation + fatal error after 10 consecutive |
| Level message delays | 5s timeout detection, warning logging |
| Thread safety | Callback-based emission, no shared state modification |

## Next Steps

1. **checklist** - Verify all test files exist and pass
2. **tasks** - Generate implementation tasks from this plan

## Artifacts Created

| Artifact | Path |
|----------|------|
| Implementation Plan | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/plan.md` |
| Research Summary | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/research.md` |
| Data Model | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/data-model.md` |
| Quickstart (Tests) | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/quickstart.md` |
| Config Schema | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/contracts/segmentation-config-schema.json` |
| Metrics Schema | `/Users/leonardofu/dev/back-end/live-broadcast-dubbing-cloud/specs/023-vad-audio-segmentation/contracts/vad-metrics-schema.json` |

## Technologies

- Python 3.10.x + pydantic >= 2.0, pydantic-settings >= 2.0, prometheus_client
- GStreamer 1.0 (PyGObject >= 3.44.0), gst-plugins-good (level element)
- pytest >= 7.0, pytest-mock, pytest-asyncio
