{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Fragment Events Schema",
  "description": "Socket.IO event schemas for fragment processing (spec 016)",
  "definitions": {
    "AudioData": {
      "type": "object",
      "properties": {
        "format": {
          "type": "string",
          "enum": ["pcm_s16le", "pcm_f32le"],
          "description": "Audio format"
        },
        "sample_rate_hz": {
          "type": "integer",
          "minimum": 8000,
          "maximum": 96000,
          "description": "Sample rate in Hz"
        },
        "channels": {
          "type": "integer",
          "enum": [1, 2],
          "description": "Number of audio channels"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "maximum": 60000,
          "description": "Fragment duration in milliseconds"
        },
        "data_base64": {
          "type": "string",
          "description": "Base64-encoded audio data"
        }
      },
      "required": ["format", "sample_rate_hz", "channels", "duration_ms", "data_base64"]
    },
    "FragmentMetadata": {
      "type": "object",
      "properties": {
        "pts_ns": {
          "type": "integer",
          "description": "Presentation timestamp in nanoseconds"
        },
        "source_pts_ns": {
          "type": "integer",
          "description": "Original input PTS"
        }
      },
      "additionalProperties": true
    },
    "ProcessingError": {
      "type": "object",
      "properties": {
        "code": {
          "type": "string",
          "description": "Error code from spec 016 section 8.1"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error description"
        },
        "stage": {
          "type": "string",
          "enum": ["asr", "translation", "tts"],
          "description": "Processing stage that failed"
        },
        "retryable": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["code", "message"]
    },
    "StageTimings": {
      "type": "object",
      "properties": {
        "asr_ms": {
          "type": "integer",
          "minimum": 0
        },
        "translation_ms": {
          "type": "integer",
          "minimum": 0
        },
        "tts_ms": {
          "type": "integer",
          "minimum": 0
        }
      },
      "required": ["asr_ms", "translation_ms", "tts_ms"]
    },
    "ProcessingMetadata": {
      "type": "object",
      "properties": {
        "asr_model": {
          "type": "string"
        },
        "translation_model": {
          "type": "string"
        },
        "tts_model": {
          "type": "string"
        },
        "gpu_utilization": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        }
      }
    }
  },
  "events": {
    "fragment:data": {
      "direction": "worker_to_sts",
      "description": "Send an audio fragment for processing",
      "payload": {
        "type": "object",
        "properties": {
          "fragment_id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique fragment ID"
          },
          "stream_id": {
            "type": "string",
            "description": "Stream identifier"
          },
          "sequence_number": {
            "type": "integer",
            "minimum": 0,
            "description": "Monotonic sequence number (0-based)"
          },
          "timestamp": {
            "type": "integer",
            "description": "Unix timestamp in milliseconds"
          },
          "audio": {
            "$ref": "#/definitions/AudioData"
          },
          "metadata": {
            "$ref": "#/definitions/FragmentMetadata"
          }
        },
        "required": ["fragment_id", "stream_id", "sequence_number", "timestamp", "audio"]
      }
    },
    "fragment:ack": {
      "direction": "bidirectional",
      "description": "Acknowledge receipt of a fragment",
      "payload": {
        "oneOf": [
          {
            "type": "object",
            "description": "STS to Worker: Fragment received and queued",
            "properties": {
              "fragment_id": {
                "type": "string"
              },
              "status": {
                "type": "string",
                "enum": ["queued", "processing"]
              },
              "queue_position": {
                "type": "integer",
                "minimum": 0,
                "description": "Position in processing queue"
              },
              "estimated_completion_ms": {
                "type": "integer",
                "minimum": 0,
                "description": "Estimated processing time"
              }
            },
            "required": ["fragment_id", "status"]
          },
          {
            "type": "object",
            "description": "Worker to STS: Processed fragment received",
            "properties": {
              "fragment_id": {
                "type": "string"
              },
              "status": {
                "type": "string",
                "enum": ["received", "applied"]
              },
              "timestamp": {
                "type": "integer",
                "description": "Acknowledgment timestamp"
              }
            },
            "required": ["fragment_id", "status", "timestamp"]
          }
        ]
      }
    },
    "fragment:processed": {
      "direction": "sts_to_worker",
      "description": "Deliver a processed audio fragment",
      "payload": {
        "type": "object",
        "properties": {
          "fragment_id": {
            "type": "string",
            "description": "Original fragment ID"
          },
          "stream_id": {
            "type": "string"
          },
          "sequence_number": {
            "type": "integer",
            "minimum": 0,
            "description": "Original sequence number"
          },
          "status": {
            "type": "string",
            "enum": ["success", "partial", "failed"]
          },
          "dubbed_audio": {
            "$ref": "#/definitions/AudioData"
          },
          "transcript": {
            "type": "string",
            "description": "ASR output"
          },
          "translated_text": {
            "type": "string",
            "description": "MT output"
          },
          "processing_time_ms": {
            "type": "integer",
            "minimum": 0,
            "description": "Total processing time"
          },
          "stage_timings": {
            "$ref": "#/definitions/StageTimings"
          },
          "error": {
            "$ref": "#/definitions/ProcessingError"
          },
          "metadata": {
            "$ref": "#/definitions/ProcessingMetadata"
          }
        },
        "required": ["fragment_id", "stream_id", "sequence_number", "status", "processing_time_ms"],
        "if": {
          "properties": {
            "status": { "const": "success" }
          }
        },
        "then": {
          "required": ["dubbed_audio"]
        }
      }
    },
    "backpressure": {
      "direction": "sts_to_worker",
      "description": "Signal that STS is experiencing high load",
      "payload": {
        "type": "object",
        "properties": {
          "stream_id": {
            "type": "string"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high"]
          },
          "current_inflight": {
            "type": "integer",
            "minimum": 0,
            "description": "Current in-flight fragment count"
          },
          "queue_depth": {
            "type": "integer",
            "minimum": 0,
            "description": "Current queue depth"
          },
          "action": {
            "type": "string",
            "enum": ["slow_down", "pause", "none"],
            "description": "Recommended worker action"
          },
          "recommended_delay_ms": {
            "type": "integer",
            "minimum": 0,
            "description": "Suggested delay before next fragment"
          }
        },
        "required": ["stream_id", "severity", "current_inflight", "queue_depth", "action"]
      }
    }
  }
}
