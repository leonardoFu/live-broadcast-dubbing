{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Fragment Event Schemas",
  "description": "JSON schemas for fragment:data, fragment:ack, and fragment:processed events in Full STS Service",
  "definitions": {
    "audio_data": {
      "type": "object",
      "description": "Audio data structure for fragment payloads",
      "required": ["format", "sample_rate_hz", "channels", "duration_ms", "data_base64"],
      "properties": {
        "format": {
          "type": "string",
          "description": "Audio format identifier (m4a for input, pcm_s16le for dubbed output)",
          "examples": ["m4a", "pcm_s16le"]
        },
        "sample_rate_hz": {
          "type": "integer",
          "description": "Sample rate in Hz",
          "minimum": 8000,
          "maximum": 96000,
          "examples": [48000, 24000, 16000]
        },
        "channels": {
          "type": "integer",
          "description": "Number of audio channels (1=mono, 2=stereo)",
          "minimum": 1,
          "maximum": 2
        },
        "duration_ms": {
          "type": "integer",
          "description": "Audio duration in milliseconds",
          "minimum": 0,
          "maximum": 60000
        },
        "data_base64": {
          "type": "string",
          "description": "Base64-encoded audio data",
          "minLength": 1
        }
      },
      "additionalProperties": false
    },
    "stage_timings": {
      "type": "object",
      "description": "Per-stage timing breakdown for processing",
      "required": ["asr_ms", "translation_ms", "tts_ms"],
      "properties": {
        "asr_ms": {
          "type": "integer",
          "description": "ASR processing time in milliseconds",
          "minimum": 0
        },
        "translation_ms": {
          "type": "integer",
          "description": "Translation processing time in milliseconds",
          "minimum": 0
        },
        "tts_ms": {
          "type": "integer",
          "description": "TTS synthesis time in milliseconds",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "processing_error": {
      "type": "object",
      "description": "Error details for failed or partial processing",
      "required": ["stage", "code", "message", "retryable"],
      "properties": {
        "stage": {
          "type": "string",
          "description": "Pipeline stage where error occurred",
          "enum": ["asr", "translation", "tts"]
        },
        "code": {
          "type": "string",
          "description": "Error code",
          "examples": [
            "TIMEOUT",
            "RATE_LIMIT_EXCEEDED",
            "DURATION_MISMATCH_EXCEEDED",
            "ASR_FAILED",
            "TRANSLATION_FAILED",
            "TTS_SYNTHESIS_FAILED",
            "INVALID_AUDIO_FORMAT",
            "GPU_OOM"
          ]
        },
        "message": {
          "type": "string",
          "description": "Human-readable error description"
        },
        "retryable": {
          "type": "boolean",
          "description": "Whether the error is transient and retryable"
        }
      },
      "additionalProperties": false
    },
    "duration_metadata": {
      "type": "object",
      "description": "Duration matching metadata for A/V sync",
      "required": ["original_duration_ms", "dubbed_duration_ms", "duration_variance_percent", "speed_ratio"],
      "properties": {
        "original_duration_ms": {
          "type": "integer",
          "description": "Original fragment duration in milliseconds",
          "minimum": 0
        },
        "dubbed_duration_ms": {
          "type": "integer",
          "description": "Dubbed audio duration in milliseconds",
          "minimum": 0
        },
        "duration_variance_percent": {
          "type": "number",
          "description": "Variance between original and dubbed duration as percentage",
          "minimum": 0
        },
        "speed_ratio": {
          "type": "number",
          "description": "Speed ratio applied for duration matching",
          "minimum": 0.5,
          "maximum": 2.0
        }
      },
      "additionalProperties": false
    },
    "fragment_data": {
      "type": "object",
      "description": "Inbound fragment:data event payload from worker",
      "required": ["fragment_id", "stream_id", "sequence_number", "timestamp", "audio"],
      "properties": {
        "fragment_id": {
          "type": "string",
          "description": "Unique fragment identifier (UUID)",
          "minLength": 1
        },
        "stream_id": {
          "type": "string",
          "description": "Stream identifier",
          "minLength": 1
        },
        "sequence_number": {
          "type": "integer",
          "description": "Monotonic sequence number (0-based)",
          "minimum": 0
        },
        "timestamp": {
          "type": "integer",
          "description": "Unix timestamp in milliseconds",
          "minimum": 0
        },
        "audio": {
          "$ref": "#/definitions/audio_data"
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "fragment_ack": {
      "type": "object",
      "description": "Fragment acknowledgment payload",
      "required": ["fragment_id", "status", "timestamp"],
      "properties": {
        "fragment_id": {
          "type": "string",
          "description": "Fragment ID being acknowledged",
          "minLength": 1
        },
        "status": {
          "type": "string",
          "description": "Acknowledgment status",
          "enum": ["queued", "processing", "received", "applied"]
        },
        "timestamp": {
          "type": "integer",
          "description": "Acknowledgment timestamp in milliseconds",
          "minimum": 0
        },
        "queue_position": {
          "type": "integer",
          "description": "Position in processing queue",
          "minimum": 0
        },
        "estimated_completion_ms": {
          "type": "integer",
          "description": "Estimated time until processing completes",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "fragment_processed": {
      "type": "object",
      "description": "Outbound fragment:processed event payload",
      "required": ["fragment_id", "stream_id", "sequence_number", "status", "processing_time_ms"],
      "properties": {
        "fragment_id": {
          "type": "string",
          "description": "Original fragment ID from fragment:data",
          "minLength": 1
        },
        "stream_id": {
          "type": "string",
          "description": "Stream identifier",
          "minLength": 1
        },
        "sequence_number": {
          "type": "integer",
          "description": "Original sequence number from fragment:data",
          "minimum": 0
        },
        "status": {
          "type": "string",
          "description": "Processing result status",
          "enum": ["success", "partial", "failed"]
        },
        "dubbed_audio": {
          "$ref": "#/definitions/audio_data",
          "description": "Synthesized dubbed audio (present for success/partial)"
        },
        "transcript": {
          "type": "string",
          "description": "ASR transcription output (source language)"
        },
        "translated_text": {
          "type": "string",
          "description": "Translation output (target language)"
        },
        "processing_time_ms": {
          "type": "integer",
          "description": "Total processing time in milliseconds",
          "minimum": 0
        },
        "stage_timings": {
          "$ref": "#/definitions/stage_timings"
        },
        "error": {
          "$ref": "#/definitions/processing_error",
          "description": "Error details (present for failed/partial)"
        },
        "metadata": {
          "$ref": "#/definitions/duration_metadata",
          "description": "Duration matching metadata"
        }
      },
      "additionalProperties": false
    }
  }
}
