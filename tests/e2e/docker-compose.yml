# E2E Test Environment - Docker Compose Configuration
# Purpose: Cross-service E2E tests for stream handler pipeline
# Services: MediaMTX (RTSP/RTMP) + media-service + echo-sts
#
# Usage:
#   docker compose -f tests/e2e/docker-compose.yml up -d
#   pytest tests/e2e/ -v
#   docker compose -f tests/e2e/docker-compose.yml down

version: '3.8'

services:
  # MediaMTX Media Server (RTSP/RTMP)
  mediamtx:
    image: bluenviron/mediamtx:latest-ffmpeg
    container_name: e2e-mediamtx
    restart: "no"
    ports:
      - "8554:8554"     # RTSP
      - "1935:1935"     # RTMP
      - "9997:9997"     # Control API
      - "9998:9998"     # Prometheus metrics
    environment:
      - MTX_RTSPADDRESS=:8554
      - MTX_RTMPADDRESS=:1935
      - MTX_APIADDRESS=:9997
      - MTX_METRICSADDRESS=:9998
      - MTX_PROTOCOLS=tcp
      - MTX_LOGLEVEL=warn
      - ORCHESTRATOR_URL=http://media-service:8080
    volumes:
      - ../../apps/media-service/deploy/mediamtx/hooks:/hooks:ro
    networks:
      - e2e-test-network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:9997/v3/paths/list"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 3s

  # Echo STS Service (Socket.IO mock)
  echo-sts:
    build:
      context: ../../apps/sts-service
      dockerfile: deploy/Dockerfile.echo
    container_name: e2e-echo-sts
    restart: "no"
    ports:
      - "8000:8000"     # Socket.IO server
    environment:
      - ECHO_HOST=0.0.0.0
      - ECHO_PORT=8000
      - REQUIRE_AUTH=false
      - LOG_LEVEL=INFO
      - PROCESSING_DELAY_MS=50
      - BACKPRESSURE_ENABLED=true
    networks:
      - e2e-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/socket.io/?transport=polling"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  # Media Service (WorkerRunner host)
  media-service:
    build:
      context: ../../apps/media-service
      dockerfile: deploy/Dockerfile
    container_name: e2e-media-service
    restart: "no"
    ports:
      - "8080:8080"     # HTTP API + metrics
    environment:
      - PORT=8080
      - LOG_LEVEL=DEBUG
      - MEDIAMTX_RTSP_URL=rtsp://mediamtx:8554
      - MEDIAMTX_RTMP_URL=rtmp://mediamtx:1935
      - STS_URL=http://echo-sts:8000
      - STS_SOCKETIO_PATH=/ws/sts
      - SEGMENT_DIR=/tmp/segments
      - METRICS_ENABLED=true
    volumes:
      - segments-data:/tmp/segments
    networks:
      - e2e-test-network
    depends_on:
      mediamtx:
        condition: service_healthy
      echo-sts:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

# Shared network for inter-service communication
networks:
  e2e-test-network:
    driver: bridge
    name: e2e-test-network

# Volumes for segment storage
volumes:
  segments-data:
    driver: local
