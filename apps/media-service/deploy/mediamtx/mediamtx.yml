# MediaMTX Configuration for Live Streaming Pipeline
# Version: v1.0+
# Purpose: Local development environment with hook-based worker triggering

# Logging Configuration (FR-014)
logLevel: info
logDestinations: [stdout]

# Timeout Configuration
# Increased to handle initial dubbing latency (~45-60s before first output)
readTimeout: 120s
writeTimeout: 120s

# Authentication Configuration
# Allow anonymous access for local development
authMethod: internal
authInternalUsers:
  - user: any
    pass:
    permissions:
      - action: publish
      - action: read
      - action: playback
      - action: api
      - action: metrics

# RTMP Server Configuration (FR-002)
rtmp: true
rtmpAddress: :1935

# RTSP Server Configuration (FR-003, FR-019)
rtsp: true
rtspAddress: :8554
protocols: [tcp]  # Force TCP to avoid UDP packet loss in Docker

# WebRTC Configuration
# Disabled for E2E tests to avoid port conflict with Control API on :8889
webrtc: false

# Control API Configuration (FR-008)
# Note: Port 9997 for dev, but E2E tests override to 8889 via MTX_APIADDRESS
api: true

# Prometheus Metrics Configuration (FR-009)
metrics: true
metricsAddress: :9998

# Playback Server Configuration (FR-010)
playback: true
playbackAddress: :9996

# Path Configuration (FR-015)
paths:
  # Input paths: Allow multiple readers without triggering not-ready
  # When worker's input pipeline (rtmpsrc) connects as a reader, don't send not-ready
  ~^live/.+/in$:
    source: publisher
    sourceOnDemand: no
    record: no
    # Only run hooks when PUBLISHER connects/disconnects (not readers)
    runOnReady: /hooks/mtx-hook ready
    runOnNotReady: /hooks/mtx-hook not-ready

  # Output paths: Normal hook behavior for monitoring
  ~^live/.+/out$:
    source: publisher
    sourceOnDemand: no
    record: no
    # Don't trigger hooks for output streams (we don't need to start workers for /out)
    # runOnReady and runOnNotReady intentionally omitted

  # Fallback for other paths (legacy/test paths)
  all_others:
    source: publisher
    sourceOnDemand: no
    record: no
    # No hooks on fallback paths
