#!/bin/sh
#
# MediaMTX Hook Script
# Called by MediaMTX when streams become ready/not-ready.
# Forwards events to the media-service orchestrator.
#
# Environment Variables (provided by MediaMTX):
#   MTX_PATH: Stream path (e.g., live/stream123/in)
#   MTX_QUERY: Query string from URL (e.g., lang=es)
#   MTX_SOURCE_TYPE: Source protocol (rtmp, rtsp, webrtc)
#   MTX_SOURCE_ID: Unique source connection identifier
#   ORCHESTRATOR_URL: Media service URL (from docker-compose)
#
# Usage:
#   mtx-hook ready      # Stream is published
#   mtx-hook not-ready  # Stream ended

set -e

EVENT_TYPE="$1"

# Validate event type
if [ -z "$EVENT_TYPE" ]; then
    echo "ERROR: Event type argument required (ready or not-ready)" >&2
    exit 1
fi

if [ "$EVENT_TYPE" != "ready" ] && [ "$EVENT_TYPE" != "not-ready" ]; then
    echo "ERROR: Invalid event type '$EVENT_TYPE' (expected 'ready' or 'not-ready')" >&2
    exit 1
fi

# Validate required environment variables
if [ -z "$MTX_PATH" ]; then
    echo "ERROR: MTX_PATH environment variable is required" >&2
    exit 1
fi

if [ -z "$MTX_SOURCE_TYPE" ]; then
    echo "ERROR: MTX_SOURCE_TYPE environment variable is required" >&2
    exit 1
fi

if [ -z "$MTX_SOURCE_ID" ]; then
    echo "ERROR: MTX_SOURCE_ID environment variable is required" >&2
    exit 1
fi

if [ -z "$ORCHESTRATOR_URL" ]; then
    echo "ERROR: ORCHESTRATOR_URL environment variable is required" >&2
    exit 1
fi

# Build JSON payload
if [ -n "$MTX_QUERY" ]; then
    PAYLOAD=$(printf '{"path":"%s","sourceType":"%s","sourceId":"%s","query":"%s"}' \
        "$MTX_PATH" "$MTX_SOURCE_TYPE" "$MTX_SOURCE_ID" "$MTX_QUERY")
else
    PAYLOAD=$(printf '{"path":"%s","sourceType":"%s","sourceId":"%s"}' \
        "$MTX_PATH" "$MTX_SOURCE_TYPE" "$MTX_SOURCE_ID")
fi

# Construct endpoint URL (remove trailing slash if present)
BASE_URL="${ORCHESTRATOR_URL%/}"
ENDPOINT_URL="${BASE_URL}/v1/mediamtx/events/${EVENT_TYPE}"

# Send HTTP POST request
echo "Sending $EVENT_TYPE event for path: $MTX_PATH"

# Use wget for HTTP POST (available in mediamtx container)
RESPONSE=$(wget -q -O - \
    --header="Content-Type: application/json" \
    --header="User-Agent: MediaMTX-Hook/1.0" \
    --post-data="$PAYLOAD" \
    --timeout=5 \
    "$ENDPOINT_URL" 2>&1) || {
    echo "ERROR: Failed to send hook event to $ENDPOINT_URL" >&2
    echo "Payload: $PAYLOAD" >&2
    exit 1
}

echo "Hook event sent successfully: $MTX_PATH -> $ENDPOINT_URL"
